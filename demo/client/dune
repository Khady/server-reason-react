(melange.emit
 (alias melange-app)
 (target app)
 (enabled_if
  (= %{profile} "dev"))
 (modules index)
 (libraries melange demo_shared_js reason-react)
 (preprocess
  (pps reason-react-ppx browser_ppx -js melange.ppx))
 (module_systems commonjs))

(rule
 (alias client)
 ; Make the client rule depend on the generated file by melange.emit, so it needs to wait to be built and it's rebuilt when the file changes.
 (deps
  (alias_rec melange-app))
 (action
  (run
   %{bin:esbuild}
   app/demo/client/index.js
   --external:react
   --external:react-dom
   --bundle
   --platform=browser
   --log-level=error
   --outfile=app/demo/client/bundle.js)))

(rule
 (alias client)
 (deps runtime.jsx)
 (action
  (progn
   (run
    %{bin:esbuild}
    %{project_root}/demo/client/runtime.jsx
    --external:react
    --external:react-dom
    --external:react-server-dom-webpack
    --bundle
    --platform=browser
    --log-level=error
    --outfile=app/demo/client/rsc.js))))
