(melange.emit
 (alias melange-app)
 (target app)
 (modules index)
 (libraries melange demo_shared_js reason-react melange.dom melange-webapi)
 (preprocess
  (pps reason-react-ppx browser_ppx -js melange.ppx))
 (module_systems
  (es6 js))
 (enabled_if
  (= %{profile} "dev")))

(rule
 (alias client)
 ; Make the client rule depend on the generated file by melange.emit, so it needs to wait to be built and it's rebuilt when the file changes.
 (deps
  (alias_rec melange-app)
  (:script bundle.mjs))
 (target bundled.js)
 (action
  (progn
   (run node %{script} app/demo/client/index.js %{target})
   (run cp %{target} app/demo/client/)))
 (enabled_if
  (= %{profile} "dev")))

(rule
 (alias client)
 (deps
  (alias_rec melange-app)
  (:input create-from-fetch.jsx)
  (:script bundle.mjs))
 (action
  (progn
   (run node %{script} %{input} "app/demo/client/")))
 (enabled_if
  (= %{profile} "dev")))

(rule
 (alias client)
 (deps
  (alias_rec melange-app)
  (:input runtime-with-client.jsx)
  (:script bundle.mjs))
 (action
  (progn
   (run node %{script} %{input} "app/demo/client/")))
 (enabled_if
  (= %{profile} "dev")))
